"use strict";function a(a){var b=a,c=!0,d=this;this.addToEditor=function(a){a.color!==b.color&&b._editor.replaceRange(a.text,{line:a.from.line,ch:a.from.ch},{line:a.to.line,ch:a.to.ch})},this.changeLanguage=function(a){a.language&&a.language.mode&&a.language.name&&(b.onSelect(a.language,!0),a.text=a.author+" has changed the language to "+a.language.name,b.addChatMessage(a))},this.cursorActivity=function(a){for(var c=0;c!==b.users.length;++c)b.users[c].color===a.color&&b.$apply(function(){b.users[c].startsel=a.startSel,b.users[c].endsel=a.endSel,b.users[c].x=a.x,b.users[c].y=a.y})},this.cut=function(a){d.deleteFromEditor(a)},this["+delete"]=function(a){d.deleteFromEditor(a)},this.deleteFromEditor=function(a){a.color!==b.color&&b._editor.replaceRange("",{line:a.from.line,ch:a.from.ch},{line:a.to.line,ch:a.to.ch})},this["+input"]=function(a){d.addToEditor(a)},this.paste=function(a){d.addToEditor(a)},this.postsubscribe=function(a){a.text=c?"Welcome "+b.name:a.name+" has entered the room",c||b.addUser({name:a.name,color:a.color,show:!1}),c=!1,b.addChatMessage(a)},this.scrollIntoView=function(a){b.addChatMessage(a)},this.sendMessage=function(a){b.addChatMessage(a)},this.subscribe=function(a){""==b.color&&(b.color=a.color,b.postSubscribe())},this.unsubscribe=function(a){b.removeUser(a.color,function(c){var d=c.name||"User";a.text=d+" has left the room",b.addChatMessage(a)})}}function b(a,b){var c=a;this.changeLanguage=function(a){var d={type:"changeLanguage",author:c.name,color:c.color,language:a};b.publish("/"+c.instanceId,JSON.stringify(d))},this.cursorActivity=function(a){var d={type:"cursorActivity",y:a.top,x:a.left,color:a.color,startSel:a.startSel,endSel:a.endSel};b.publish("/"+c.instanceId,JSON.stringify(d))},this.cut=function(a){var d={type:"cut",author:c.name,color:c.color,from:{ch:a.from.ch,line:a.from.line},to:{ch:a.to.ch,line:a.to.line}};b.publish("/"+c.instanceId,JSON.stringify(d))},this["+delete"]=function(a){var d={type:"+delete",author:c.name,color:c.color,from:{ch:a.from.ch,line:a.from.line},to:{ch:a.to.ch,line:a.to.line}};b.publish("/"+c.instanceId,JSON.stringify(d))},this["+input"]=function(a,d){for(var e=[],f=0;f<a.text.length;++f)e.push(d.getLine(a.from.line+f));var g={type:"+input",author:c.name,color:c.color,from:{ch:a.from.ch,line:a.from.line},to:{ch:a.to.ch,line:a.to.line},text:a.text.join("\n"),lines:e};b.publish("/"+c.instanceId,JSON.stringify(g))},this.paste=function(a){var d={type:"paste",author:c.name,color:c.color,from:{ch:a.from.ch,line:a.from.line},to:{ch:a.to.ch,line:a.to.line},text:a.text.join("\n")};b.publish("/"+c.instanceId,JSON.stringify(d))},this.scrollIntoView=function(a){var a={type:"scrollIntoView",author:c.name,color:c.color,text:"Look at line "+(a.line+1),line:a.line};b.publish("/"+c.instanceId,JSON.stringify(a))},this.sendMessage=function(a){var d={type:"sendMessage",author:c.name,color:c.color,text:a};b.publish("/"+c.instanceId,JSON.stringify(d))}}var c=angular.module("MyApp",["ngRoute","ngAnimate","ui.bootstrap","ui.codemirror","luegg.directives"]);c.config(["$routeProvider","$locationProvider",function(a,b){a.when("/:id",{templateUrl:"partials/partialInstance.html",controller:"InstanceCTRL"}).otherwise({redirectTo:"/"}),b.html5Mode(!0)}]),c.factory("Faye",["$log","$http",function(a,b){var c,d=new Faye.Client("/faye",{timeout:60});return{publish:function(a,b){d.publish(a,b)},subscribe:function(a,b){return c=d.subscribe(a,b)},unsubscribe:function(){c.cancel()},getUsers:function(a,c){b.get("/"+a+"/users").then(function(a){c(a.data)})},getFile:function(a,c){b.get("/"+a+"/file").then(function(a){c(a.data)})}}}]),c.factory("CodeMirrorEditor",[function(){var a;return{setEditor:function(b){a=b},getEditor:function(){return a}}}]),c.filter("notme",function(){return function(a,b){for(var c=[],d=0;d!=a.length;++d)a[d].color!==b.color&&c.push(a[d]);return c}}),c.filter("orderByName",function(){return function(a){function b(a,b){var a=a.name.toLowerCase(),b=b.name.toLowerCase();return b>a?-1:a>b?1:0}return a.sort(b),a}}),c.directive("usercursor",["CodeMirrorEditor",function(a){var b,c,d,e;return{restrict:"E",transclude:!0,template:"<div ng-transclude></div>",link:function(f,g,h){g.addClass("userCursor"),e=f.$eval(h.color),a.getEditor().addWidget({line:0,ch:0},g[0]),f.$watch(h.name,function(a){g.html(a)}),f.$watch(h.startsel,function(f){b=f,d&&d.clear(),c&&!angular.equals(b,c)&&(d=a.getEditor().markText(b,c,{css:"background-color:"+e+";"}))},!0),f.$watch(h.endsel,function(f){c=f,d&&d.clear(),b&&!angular.equals(b,c)&&(d=a.getEditor().markText(b,c,{css:"background-color:"+e+";"}))},!0),f.$watch(h.x,function(a){g.css("left",a+"px")}),f.$watch(h.y,function(a){g.css("top",a+"px")})}}}]),c.controller("InstanceCTRL",["$scope","$routeParams","Faye","$sce","$modal","CodeMirrorEditor","$timeout",function(c,d,e,f,g,h,i){c.languages=[{name:"JavaScript",mode:"javascript"},{name:"Go",mode:"go"},{name:"SQL",mode:"sql"},{name:"Python",mode:"python"},{name:"Ruby",mode:"ruby"},{name:"Shell",mode:"shell"},{name:"Java",mode:"text/x-java"},{name:"C++",mode:"text/x-c++src"},{name:"C",mode:"text/x-csrc"},{name:"C#",mode:"text/x-csharp"}],c.editorOptions={value:"\n\n\n",lineNumbers:!0,matchBrackets:!0,mode:"javascript",theme:"monokai"},c.codemirrorLoaded=function(a){h.setEditor(a),c._editor=a,a.on("change",function(a,b){var d=c.sendEvents[b.origin];d&&d(b,a)}),a.on("cursorActivity",function(a){c.sel&&c.sel.clear();var b=a.cursorCoords(!1,"local");b.startSel=a.getCursor(!0),b.endSel=a.getCursor(!1),b.color=c.color;var d=c.sendEvents.cursorActivity;d&&d(b)}),a.on("gutterClick",function(a,b){var d=a.lineInfo(b),e=c.sendEvents.scrollIntoView;e&&e(d)})},c.addUser=function(a){c.$apply(function(){c.users.push(a)})},c.addChatMessage=function(a){c.$apply(function(){c.comments.length>=40&&c.comments.splice(0,1),c.comments.push(a)})},c.onSelect=function(a,b){var d=a.mode;if(d){c.selectedLanguage="",c.currentLanguage=a.name,c.editorOptions.mode=d,c._editor.setOption("mode",c.editorOptions.mode);var e=c.sendEvents.changeLanguage;e&&!b&&e(a)}},c.validateSelection=function(){for(var a,b=!0,d=0;d<c.languages.length;++d)c.languages[d].name==c.selectedLanguage&&(b=!1),c.languages[d].mode==c.editorOptions.mode&&(a=c.languages[d].name);c.selectedLanguage!=a&&(b=!0),b&&a&&(c.currentLanguage=a)},c.goToLine=function(a){if(a){var b=c._editor;b.scrollIntoView({line:a,ch:0}),b.addLineClass(a,"text","line-active"),i(function(){b.removeLineClass(a,"text","line-active")},200)}},c.messageEvent=function(){var a=c.messageText;13===event.keyCode&&""!==a.trim()&&(c.messageText="",c.sendEvents.sendMessage(a))},c.removeUser=function(a,b){for(var d=0;d!=c.users.length;++d){var e=c.users[d].color;if(a==e){var f=c.users.splice(d,1);b(f[0]);break}}},c.mouseMoved=function(a){for(var b=0;b<c.users.length;++b){var d=a.x-c.users[b].x,e=a.y-c.users[b].y,f=Math.pow(d,2)+Math.pow(e,2);f=parseInt(Math.sqrt(f)),100>=f&&!c.users[b].show?c.users[b].show=!0:f>100&&c.users[b].show&&(c.users[b].show=!1)}},c.to_trusted=function(a){return f.trustAsHtml(a)},c.who=function(){return c.users.length},c.postSubscribe=function(){var a={type:"postsubscribe",name:c.name,color:c.color};e.publish("/"+c.instanceId,JSON.stringify(a))},c.init=function(){c.receiveEvents=new a(c),c.sendEvents=new b(c,e),c.name="",c.showChat=!0,c.instanceId=d.id,c.color="",c.comments=[],c.users=[],c.selectedLanguage="",c.currentLanguage=c.languages[0].name},c.fayeLoading=function(){e.getUsers(c.instanceId,function(a){for(var b=0;b!=a.length;++b)c.users.push({name:a[b].name,color:a[b].color})}),e.getFile(c.instanceId,function(a){c._editor.setValue(JSON.parse(a))}),e.subscribe("/"+c.instanceId,function(a){var b=JSON.parse(a),d=c.receiveEvents[b.type];d&&d(b)}),angular.element(window).bind("beforeunload",function(){e.unsubscribe()})},c.open=function(){var a=g.open({templateUrl:"modal.html",controller:"ModalCtrl",backdrop:"static"});a.result.then(function(a){c.name=a,c.fayeLoading(),c._editor.focus()})},c.init(),c.open()}]),c.controller("ModalCtrl",["$scope","$modalInstance",function(a,b){a.ok=function(a){""!==a.trim()&&b.close(a)},a.enter=function(b,c){13===b.keyCode&&a.ok(c)}}]);